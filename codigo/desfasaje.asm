.include "m328pdef.inc"

.DEF TENSION_LEIDA = R16
.DEF TENSION_INICIAL = R17
.DEF REG_VACIO = R19
.DEF TEMP = R20
.DEF TIEMPO_ARRIBA = R21
.DEF TIEMPO_TOTAL = R22

.CSEG
	RJMP MAIN

.EQU MASK_LECTURA_TENSION = 0xFF
.EQU PENDIENTE = 10
.EQU ORDENADA_ORIGEN = 25

.ORG 0X001C
	RJMP ISR_TIMER0_COMPA

.ORG INT_VECTORS_SIZE

MAIN:
;INICIALIZACION STACK
	LDI TEMP,HIGH(RAMEND)
	OUT SPH,TEMP
	LDI TEMP,LOW(RAMEND)
	OUT SPL,R16
;[FIN]INICIALIZACION STACK

;SETEO EL PUERTO C DE SALIDA
	LDI TEMP,DDRC
	ORI TEMP,MASK_LECTURA_TENSION
	OUT DDRC,TEMP
;[FIN]SETEO EL PUERTO C DE SALIDA

	IN TEMP,TCCR0A
	ANDI TEMP,(1<<WGM01)
	OUT TCCR0A,TEMP

	LDI TEMP,0X02
	OUT TCCR0A,TEMP

	LDI TEMP,0X04
	OUT OCR0A,TEMP

	LDI TEMP,0X02
	STS TIMSK0,TEMP

	SEI

	CLR REG_VACIO
	CLR TIEMPO_ARRIBA
	CLR TIEMPO_TOTAL
	CALL ESPERAR_PARA_ARRANCAR
	
HERE:RJMP HERE

ESPERAR_PARA_ARRANCAR:
	IN TENSION_INICIAL,PORTC;LEO TENSION INICIAL DEL ADC
LOOP_HASTA_ARRANCAR:
	IN TENSION_LEIDA,PORTC;LEO TENSION DEL ADC
	CP TENSION_INICIAL,TENSION_LEIDA
	BREQ LOOP_HASTA_ARRANCAR
	
INIT_LEER_PULSO:
	MOV TENSION_INICIAL,TENSION_LEIDA

LEER_PULSO:
	IN TENSION_LEIDA,PORTC;LEO TENSION DEL ADC
	INC TIEMPO_ARRIBA
	INC TIEMPO_TOTAL
	CP TENSION_INICIAL,TENSION_LEIDA
	BREQ LEER_PULSO

VERIFICAR_T1:
	CP TIEMPO_ARRIBA,TIEMPO_TOTAL
	BREQ INIT_LEER_PULSO

CALCULAR_TIEMPOS:
	CP TENSION_INICIAL,0
	BRNE PASAR_DE_PULSOS_A_TIEMPO
	MOV TEMP,TIEMPO_TOTAL
	SUB TEMP,TIEMPO_ARRIBA
	MOV TIEMPO_ARRIBA,TEMP

PASAR_DE_PULSOS_A_TIEMPO:
RET

CONTADOR:
	IN R16,TCNT0
	IN R16 OCR0A
RJMP CONTADOR

ISR_TIMER0_COMPA:
	LDI R17,0X00
	OUT TCNT0,R17
RETI
